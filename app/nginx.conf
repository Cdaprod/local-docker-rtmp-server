worker_processes auto;
rtmp_auto_push on;
rtmp_auto_push_reconnect 1s;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;

    server {
        listen 18080;
        server_name localhost;

        # RTMP Statistics in XML
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            root html;
        }

        location / {
            root html;
            index index.html index.htm;
        }

        # Health check endpoint
        location /health {
            return 200 "healthy\n";
        }
    }
}

rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        timeout 30s;

        # iPhone RTMP Stream
        application iphone {
            live on;
            record off;
            allow publish 192.168.0.10;  # iPhone broadcast (Primary Controller and Screensharer)
            allow play all;

            # Intercept when the iPhone publishes and redirect to /scene-iphone
            on_publish_exec ffmpeg -i rtmp://localhost/iphone/$name \
                -c:v libx264 -preset fast -b:v 4500k -maxrate 4500k -bufsize 9000k \
                -vf "scale=1080x2336:force_original_aspect_ratio=decrease,pad=1080:2336:(ow-iw)/2:(oh-ih)/2" \
                -c:a aac -b:a 128k -f flv rtmp://localhost/scene-iphone/$name;

            # Fallback to the placeholder image when idle
            idle_streams on;
            exec ffmpeg -loop 1 -re -i /app/public/assets/cdaprod-be-right-back.jpeg \
                -vf "scale=1080x2336:force_original_aspect_ratio=decrease,pad=1080:2336:(ow-iw)/2:(oh-ih)/2" \
                -c:v libx264 -preset veryfast -tune stillimage -b:v 600k \
                -c:a aac -ar 44100 -b:a 128k -f flv rtmp://localhost/scene-iphone/placeholder;
        }

        # Scene for iPhone streams
        application scene-iphone {
            live on;
            record all;
            record_path /data/recordings/scene-iphone;
            record_unique on;
            allow publish 127.0.0.1;  # Only internal publisher
            deny publish all;         # Deny all others
            allow play all;
        }

        # Nikon RTMP Stream
        application nikon {
            live on;
            record off;
            allow publish 192.168.0.187;  # Nikon laptop (OBS/Prism websocket)
            allow play all;
        }

        # MacBook RTMP Stream
        application macbook {
            live on;
            record off;
            allow publish 192.168.0.9;    # MacBook broadcast (Auxiliary Controller)
            allow play all;
        }

        # Composite Scene
        application scene {
            live on;
            record all;
            record_path /data/recordings/scene;
            record_unique on;
            allow publish 127.0.0.1;      # Only internal publisher (FFmpeg)
            deny publish all;             # Deny all others
            allow play all;

            # Combine streams into a single scene
            exec ffmpeg \
                -re \
                -i rtmp://localhost/nikon/$name \
                -i rtmp://localhost/macbook/$name \
                -i rtmp://localhost/scene-iphone/$name \
                -filter_complex "[0:v] scale=1280x720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2 [v0]; \
                                 [1:v] scale=1280x720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2 [v1]; \
                                 [2:v] scale=720x1280:force_original_aspect_ratio=decrease,pad=720:1280:(ow-iw)/2:(oh-ih)/2 [v2]; \
                                 [v0][v1][v2] hstack=inputs=3 [out]" \
                -map "[out]" -c:v libx264 -preset fast -b:v 6000k \
                -c:a aac -ar 44100 -b:a 128k -f flv rtmp://localhost/stream/$name;
        }

        # Final Processed Stream
        application stream {
            live on;
            record all;
            record_path /data/recordings/final;
            record_unique on;
            allow publish 127.0.0.1;      # Only internal publisher
            deny publish all;
            allow play all;
        }

        # HLS Generation
        application hls {
            live on;
            hls on;
            hls_path /tmp/hls;
            hls_fragment 2s;
            hls_playlist_length 30s;

            # HLS Variants
            hls_variant _1080p60 BANDWIDTH=6000000,RESOLUTION=1920x1080,FRAME-RATE=60;
            hls_variant _1080p30 BANDWIDTH=4500000,RESOLUTION=1920x1080,FRAME-RATE=30;
            hls_variant _720p BANDWIDTH=3000000,RESOLUTION=1280x720;
            hls_variant _480p BANDWIDTH=1500000,RESOLUTION=854x480;
            hls_variant _360p BANDWIDTH=800000,RESOLUTION=640x360;

            allow publish 127.0.0.1;      # Only internal transcoder
            deny publish all;
            allow play all;
        }
    }
}